ChangeLog:
2008-02-15 17:41 Ver 1.0 痴漢公賊

这是我汉化爱上姐姐（♂）的少女DVD版完全版用到的工具，这些工具都是我自己写的，发布出来就是为了让大家了解一下爱上姐姐（♂）的少女DVD版完全版汉化的一些技术细节，相信阅读本文的人也有能力自己做一只爱上姐姐（♂）的少女DVD版完全版的汉化了，不，应该说是任何一款Caramel-Box的游戏汉化了（Caramel-Box近期出的游戏都支持，但不保证以后出的也能支持），而且这些工具可以随意使用。当然这个文档说的已经极度简化了，为的也是大多数人都能看懂。

【汉化步骤】
1. 资源提取
使用crass提取游戏目录下的system.bin文件。提取出来的资源一般都有2重扩展名，后面的一重是为了能让提取者一目了然提取出的资源的类型，封包时注意要去掉后面的一重。
crass下载地址：http://bbs.jgames.net/ForumDisplay-213387-0-1-1.html
请使用0.4.7.17或之后的版本。

2. 资源整理
汉化的目标资源是图和脚本。图的后缀是.png，脚本的后缀是.scb，其他的资源都没有汉化的必要。

3. exe修改
很早以前改的了，具体忘了，所以从略。

4. 编写封包器
封包器我写成了dll，原因是汉化补丁安装时通过nsis外挂dll的功能对目标.bin进行打补丁，所以写成dll一举两得。
封包器的核心实现方式参见源码，这里特别指出的是封包时使用了一个小技巧：
将汉化的资源直接附加到文件结尾，然后修正目录项中资源偏移的值使其指向你的汉化资源的位置。
这样旧的原始资源还在bin的内部，只不过失去了索引。这比起上一版的汉化补丁里的封包器要高明很多，而且可以对同一个资源反复打补丁。
上一版本里的封包器要想正常工作，首先借助内部的解包器把资源全都提取出来，然后再把这些资源连同汉化了的资源一起打包，费时费地儿。
当然，如果你打算在别的游戏里也应用这个技巧也是可行的，但是具体情况具体分析，要考虑实际的封包格式是否允许你这样做（有时候可能要配合exe修改）。
实际上完美一点的话也可以利用resource_header里的一些字段来保存原始的资源的位置，这样就可以轻松的可以恢复成日文版了，可是我还是选择笨拙的备份文件的方式咯。

5. 脚本提取和写回
脚本文件是.scb，典型的二进制脚本。文本集中在文件尾部，所以是十分好处理的类型。otbokucv_toolet_Ver1.09里有脚本写回的程序，其原理非常简单：把前面的控制部直接copy过来，然后把翻译好的文本一句一句添加到尾部即可。具体的操作方法参见其中的README。

6. 编写nsis脚本
这个我主要抄袭的是ComicPartyDCE的安装脚本，所以就没什么好说的了，唯一不同的是我用的是外部dll的方法。
ComicPartyDCE的安装脚本：
http://bbs.sumisora.com/read.php?tid=212871&fpage=3

【其他说明】
1. 目录结构
source － 源码
	CaramelBox_test － 封包器wrapper程序源码
	CaramelBox_patch － 封包器dll模块源码
	nsis － 汉化补丁安装程序的脚本源码
program － 二进制程序
	dll － CaramelBox_patch封包器用到的其他辅助dll模块
	otbokucv_toolet_Ver1.09 － 以前开发的汉化工具集合，后来笔记本硬盘毁掉，这套工具的源码也就没有了。现在的汉化版实际上是crass+CaramelBox_patch+otbukocv_text_writeback制作的。
nsis － 补丁安装程序需要的素材、汉化的资源以及脚本

2. CaramelBox_test的使用
源码中还有个CaramelBox_test的程序，它就是用于测试封包器的wrapper程序，需要给它传递2个参数才能正常运行（这是一个控制台程序）：

	loading CaramelBox_patch ...
	data.bin: patching $$$*0000005 ... Failed(-99)
	unaten.bin: patching $$$*0000005 ... OK
	patching over ...

第一个参数是.bin文件所在的目录名；第二个参数是你要写回的资源名称（注意如果是2重资源扩展名，要自己手动或用别的工具去掉最后1重扩展名）。
封包器会自动找到合适的.bin文件并对起进行写回处理，所以第一个信息“data.bin: patching $$$*0000005 ... Failed(-99)”出错原因是第一个data.bin文件里没有包含X0000005.$$$这个资源。
注意：这里测试的游戏是Caramel-Box的うつりぎ七恋天気あめ。

3. 编译自己的CaramelBox_patch
如果你想编译自己的CaramelBox_patch，就把所有My开头的函数换成Win32 API对应的函数即可；再把和unicode相关的几个函数处理一下就行了。

4. 其他未说明的细节
.bin的封包格式含有很多细节没有详细说明，甚至封包器里都没用到。实际上这些细节的大部分都在解包器里涉及到了，封包器只不过是利用了现有的一些假设忽略了那些细节。有朝一日我会公布解包器的完整源码的，现阶段对于封包器来说，那些细节即使忽略也不会影响什么。
